<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:EVBHelper.ViewModels.Dtb"
             mc:Ignorable="d"
             x:Class="EVBHelper.Views.DtbEditorView"
             x:DataType="vm:DtbEditorViewModel">
    <Grid RowDefinitions="Auto,Auto,*" ColumnDefinitions="2*,3*" RowSpacing="16" ColumnSpacing="16" Margin="0">
        <Border Grid.ColumnSpan="2" Padding="16" CornerRadius="12" Background="{DynamicResource ThemeControlMidBrush}">
        <StackPanel Spacing="12">
        <WrapPanel VerticalAlignment="Center">
            <Button Content="Open DTB"
                            Command="{Binding OpenCommand}"
                            Theme="{DynamicResource SolidButton}"
                Classes="Secondary"
                Margin="0,0,8,8" />
                    <Button Content="Save"
                            Command="{Binding SaveCommand}"
                            Theme="{DynamicResource SolidButton}"
                Classes="Primary"
                Margin="0,0,8,8" />
                    <Button Content="Save As"
                            Command="{Binding SaveAsCommand}"
                            Theme="{DynamicResource SolidButton}"
                Classes="Secondary"
                Margin="0,0,8,8" />
                    <ToggleSwitch Content="Hex for new property"
                  IsChecked="{Binding NewPropertyUseHex}"
                  Margin="0,0,8,8" />
                    <TextBlock Text="*"
                               Foreground="{DynamicResource ThemeAccentBrush}"
                               FontWeight="Bold"
                               VerticalAlignment="Center"
                   IsVisible="{Binding IsDirty}"
                   Margin="0,0,8,8"/>
                </WrapPanel>
                <TextBlock TextWrapping="Wrap">
                    <Run Text="Current file: " />
                    <Run Text="{Binding CurrentFilePath, TargetNullValue='(none)', FallbackValue='(none)'}" />
                </TextBlock>
                <TextBlock Text="{Binding StatusMessage}"
                           FontWeight="SemiBold"
                           TextWrapping="Wrap" />
            </StackPanel>
        </Border>

        <Border Grid.Row="1" Grid.Column="0" CornerRadius="12" Padding="16" Background="{DynamicResource ThemeControlMidBrush}">
            <Grid RowDefinitions="Auto,Auto,*" RowSpacing="12">
                <StackPanel Orientation="Horizontal" Spacing="8">
            <TextBlock Text="Node name:" VerticalAlignment="Center" />
                    <TextBox Text="{Binding SelectedNode.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="200" IsEnabled="{Binding SelectedNode}" />
                </StackPanel>
        <WrapPanel Grid.Row="1"> <!-- Added Grid.Row to prevent overlap -->
            <TextBox Width="160"
                 Watermark="New node name"
                 Text="{Binding NewNodeName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                 Margin="0,0,8,8" />
            <Button Content="Add child node"
                Command="{Binding AddNodeCommand}"
                Theme="{DynamicResource SolidButton}"
                Classes="Secondary"
                Margin="0,0,8,8" />
            <Button Content="Delete node"
                Command="{Binding RemoveNodeCommand}"
                Theme="{DynamicResource SolidButton}"
                Classes="Warning"
                Margin="0,0,8,8" />
        </WrapPanel>
                <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                    <TreeView
                          ItemsSource="{Binding Nodes}"
                          SelectedItem="{Binding SelectedNode, Mode=TwoWay}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
                        <TreeView.DataTemplates>
                            <TreeDataTemplate ItemsSource="{Binding Children}" DataType="vm:DtbNodeViewModel">
                                <TextBlock Text="{Binding DisplayName}" />
                            </TreeDataTemplate>
                        </TreeView.DataTemplates>
                    </TreeView>
                </ScrollViewer>
            </Grid>
        </Border>

        <Border Grid.Row="1" Grid.Column="1" CornerRadius="12" Padding="16" Background="{DynamicResource ThemeControlMidBrush}">
            <Grid RowDefinitions="Auto,Auto,*" RowSpacing="12">
        <WrapPanel VerticalAlignment="Center">
            <TextBox Width="160"
                 Watermark="Property name"
                 Text="{Binding NewPropertyName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                 Margin="0,0,8,8" />
            <TextBox Width="220"
                 Watermark="Property value"
                 Text="{Binding NewPropertyValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                 Margin="0,0,8,8" />
            <Button Content="Add property"
                Command="{Binding AddPropertyCommand}"
                Theme="{DynamicResource SolidButton}"
                Classes="Secondary"
                Margin="0,0,8,8" />
            <Button Content="Delete property"
                Command="{Binding RemovePropertyCommand}"
                Theme="{DynamicResource SolidButton}"
                Classes="Warning"
                Margin="0,0,8,8" />
        </WrapPanel>
                <TextBlock Grid.Row="1"
               Text="Properties"
                           Classes="H5" />
                <Border Grid.Row="2" Background="{DynamicResource ThemeBackgroundBrush}" Padding="12" CornerRadius="8">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ListBox ItemsSource="{Binding SelectedNode.Properties}"
                                 SelectedItem="{Binding SelectedProperty, Mode=TwoWay}"
                                 BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate x:DataType="vm:DtbPropertyViewModel">
                                    <Border Padding="8" Margin="0,0,0,8" Background="{DynamicResource ThemeControlLowBrush}" CornerRadius="8">
                                        <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="8" ColumnSpacing="12">
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                            <CheckBox Grid.Column="1"
                                                      Content="Hexadecimal"
                                                      IsChecked="{Binding UseHexEditing, Mode=TwoWay}"
                                                      IsEnabled="{Binding CanEditAsText}" />
                                            <TextBox Grid.Row="1" Grid.ColumnSpan="2"
                                                     Text="{Binding EditorValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                     FontFamily="{Binding EditorFontFamily}"
                                                     AcceptsReturn="{Binding EditorAcceptsReturn}"
                                                     TextWrapping="Wrap"
                                                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                                                     MinHeight="60" />
                                            <TextBlock Grid.Row="2"
                                                       Grid.ColumnSpan="2"
                                                       Text="{Binding ValidationError}"
                                                       Foreground="{DynamicResource ThemeAccentBrush}" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>
