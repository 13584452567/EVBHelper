<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:EVBHelper.ViewModels.OpenixIMG"
             xmlns:conv="using:EVBHelper.Converters"
             xmlns:models="using:EVBHelper.Models"
             mc:Ignorable="d"
             x:Class="EVBHelper.Views.OpenixImgView"
             x:DataType="vm:OpenixImgViewModel">
    <UserControl.Resources>
        <conv:OpenixLogLevelToBrushConverter x:Key="OpenixLogBrush" />
        <conv:InverseBoolConverter x:Key="InverseBoolConverter" />
        <conv:NullToBoolConverter x:Key="NullToBoolConverter" />
    </UserControl.Resources>

    <Grid ColumnDefinitions="2*,3*" ColumnSpacing="18">
        <Border Padding="16" CornerRadius="12" Background="{DynamicResource ThemeControlMidBrush}">
            <StackPanel Spacing="16">
                <TextBlock Text="OpenixIMG Operations" FontSize="18" FontWeight="SemiBold" />

                <StackPanel Spacing="8">
                    <TextBlock Text="Image File" FontWeight="SemiBold" />
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                        <TextBox Text="{Binding InputImagePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 Watermark="Select .img or .fex file"
                                 IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />
                        <Button Grid.Column="1"
                                Content="Browse"
                                Command="{Binding BrowseImageCommand}"
                                Theme="{DynamicResource SolidButton}"
                                Classes="Secondary" />
                    </Grid>
                    <CheckBox Content="Generate cfg"
                              IsChecked="{Binding GenerateCfg}"
                              IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />
                </StackPanel>

        <StackPanel Orientation="Horizontal" Spacing="8">
                    <Button Content="Unpack"
                            Command="{Binding UnpackCommand}"
                            Theme="{DynamicResource SolidButton}"
                            Classes="Primary" />
                    <Button Content="Decrypt"
                            Command="{Binding DecryptCommand}"
                            Theme="{DynamicResource SolidButton}"
                            Classes="Secondary" />
            <Button Content="Show Partitions"
                            Command="{Binding ShowPartitionCommand}"
                            Theme="{DynamicResource SolidButton}"
                            Classes="Secondary" />
            <Button Content="Inspect"
                Command="{Binding InspectCommand}"
                Theme="{DynamicResource SolidButton}"
                Classes="Secondary" />
            <Button Content="Pack"
                Command="{Binding PackCommand}"
                Theme="{DynamicResource SolidButton}"
                Classes="Success" />
                </StackPanel>

                <Separator />

                <StackPanel Spacing="6">
                    <TextBlock Text="Status" FontWeight="SemiBold" />
                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                        <ProgressBar Width="140"
                                     IsIndeterminate="{Binding IsBusy}"
                                     IsVisible="{Binding IsBusy}" />
                        <TextBlock Text="{Binding StatusMessage}"
                                   Foreground="{Binding StatusLevel, Converter={StaticResource OpenixLogBrush}}"
                                   TextWrapping="Wrap"
                                   MaxWidth="260" />
                    </StackPanel>
                    <TextBlock Text="{Binding PartitionSummary}"
                               FontStyle="Italic"
                               Foreground="{DynamicResource ThemeAccentBrush}"
                               TextWrapping="Wrap"
                               IsVisible="{Binding PartitionSummary, Converter={StaticResource NullToBoolConverter}}" />
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Cancel"
                                Command="{Binding CancelCommand}"
                                Theme="{DynamicResource SolidButton}"
                                Classes="Warning" />
                        <Button Content="Clear Logs"
                                Command="{Binding ClearLogsCommand}"
                                Theme="{DynamicResource SolidButton}"
                                Classes="Secondary"
                                IsEnabled="{Binding HasLogs}" />
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </Border>

        <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto,*" RowSpacing="12">
            <Border Padding="16" CornerRadius="12" Background="{DynamicResource ThemeControlMidBrush}">
                <StackPanel Orientation="Horizontal" Spacing="16">
                    <TextBlock Text="Header" FontSize="18" FontWeight="SemiBold" />
                    <TextBlock Text="{Binding HeaderSummary}" />
                    <TextBlock Text="Encrypted:" />
                    <TextBlock Text="{Binding IsEncrypted}" FontWeight="SemiBold" />
                </StackPanel>
            </Border>

            <Border Grid.Row="1" Padding="12" CornerRadius="12" Background="{DynamicResource ThemeControlMidBrush}">
                <Grid RowDefinitions="Auto,Auto,*" RowSpacing="6">
                    <TextBlock Text="Files" FontSize="16" FontWeight="SemiBold" />
                    <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8">
                        <Button Content="Export Selected" Command="{Binding ExportSelectedCommand}" />
                    </StackPanel>
                    <DataGrid Grid.Row="2"
                              ItemsSource="{Binding Files}"
                              SelectedItem="{Binding SelectedFile, Mode=TwoWay}"
                              AutoGenerateColumns="False"
                              CanUserSortColumns="True"
                              HeadersVisibility="Column"
                              IsReadOnly="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="#" Binding="{Binding Index}" Width="40"/>
                            <DataGridTextColumn Header="MainType" Binding="{Binding MainType}"/>
                            <DataGridTextColumn Header="SubType" Binding="{Binding SubType}"/>
                            <DataGridTextColumn Header="FileName" Binding="{Binding FileName}" Width="2*"/>
                            <DataGridTextColumn Header="Original" Binding="{Binding OriginalLength}"/>
                            <DataGridTextColumn Header="Stored" Binding="{Binding StoredLength}"/>
                            <DataGridTextColumn Header="Offset" Binding="{Binding Offset}"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>

            <Border Grid.Row="2" Padding="16" CornerRadius="12" Background="{DynamicResource ThemeControlMidBrush}">
                <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                    <TextBlock Text="Logs" FontSize="18" FontWeight="SemiBold" />
                    <TextBlock Text="{Binding Logs.Count, StringFormat='({0})'}" Foreground="{DynamicResource ThemeAccentBrush}" />
                </StackPanel>
            </Border>

            <Border Grid.Row="3" Padding="16" CornerRadius="12" Background="{DynamicResource ThemeControlMidBrush}">
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding Logs}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="models:OpenixLogEntry">
                                <Border Margin="0,0,0,8" Padding="10" CornerRadius="8" Background="{DynamicResource ThemeBackgroundBrush}">
                                    <TextBlock Text="{Binding DisplayText}"
                                               Foreground="{Binding Level, Converter={StaticResource OpenixLogBrush}}"
                                               TextWrapping="Wrap" />
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>
        </Grid>
    </Grid>
</UserControl>